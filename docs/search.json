[
  {
    "objectID": "about.html",
    "href": "about.html",
    "title": "Species i in site j",
    "section": "",
    "text": "Two early career ecologists pondering on things, ecology, R, and all that.\nMax Lindmark is a Researcher at the Institute of Marine Research – SLU Aqua\nFederico Maioli is a PhD student at the University of Bologna"
  },
  {
    "objectID": "posts/latandlon/index.html",
    "href": "posts/latandlon/index.html",
    "title": "From Decimal Minutes to Decimal Degrees for your analysis",
    "section": "",
    "text": "It might happen that Latitude and Longitude of your spatially referenced data are formatted like this c(4530.12, 1310.02), i.e. as Decimal Minutes (D° M.M’). This is likely not a friendly a format for your analysis. However, with this function you can convert it to the more R friendly format Decimal Degrees (D.D°). The function was provided me by Patrik Börjesson (SLU Aqua)."
  },
  {
    "objectID": "posts/latandlon/index.html#reproducible-example",
    "href": "posts/latandlon/index.html#reproducible-example",
    "title": "From Decimal Minutes to Decimal Degrees for your analysis",
    "section": "Reproducible example",
    "text": "Reproducible example\n\nlat.dm.m = 4530.12\nlat.d.d = format.position(lat.dm.m)\nlat.d.d\n\n[1] 45.5"
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Species i in site j",
    "section": "",
    "text": "Order By\n       Default\n         \n          Date - Oldest\n        \n         \n          Date - Newest\n        \n         \n          Title\n        \n         \n          Author\n        \n     \n  \n    \n      \n      \n    \n\n\n\n\n\n\n\n\nDate\n\n\nTitle\n\n\nAuthor\n\n\nReading Time\n\n\n\n\n\n\n\n\n\nFeb 4, 2023\n\n\nFitting a Pütter/von Bertalanffy ODE in brms\n\n\nMax Lindmark\n\n\n15 min\n\n\n\n\n\n\n\nFeb 3, 2023\n\n\nExemplifying random effects with a fish growth dataset\n\n\nMax Lindmark\n\n\n4 min\n\n\n\n\n\n\n\nSep 18, 2022\n\n\nFrom Decimal Minutes to Decimal Degrees for your analysis\n\n\nFederico Maioli\n\n\n0 min\n\n\n\n\n\n\nNo matching items"
  },
  {
    "objectID": "posts/random_effects/index.html",
    "href": "posts/random_effects/index.html",
    "title": "Exemplifying random effects with a fish growth dataset",
    "section": "",
    "text": "library(RCurl)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(patchwork)\nlibrary(viridis)\nlibrary(lme4)\nlibrary(ggplot2); theme_set(theme_light())\n# Discrete colors\nscale_colour_discrete <- function(...) {\n  scale_colour_viridis(discrete = TRUE, option = \"cividis\")\n}\n\n# Read, crop and clean data\nd <- readr::read_csv(\"https://raw.githubusercontent.com/maxlindmark/warm-life-history/master/data/for_fitting/growth_scaling_dat.csv\") %>% \n  filter(area == \"FM\" & catch_age == 6) %>% \n  dplyr::select(length, catch_age, back_calc_age, ID) %>% \n  filter(ID %in% head(unique(ID), 50)) %>% # filter 50 individuals\n  rename(age = back_calc_age) %>% \n  mutate(age_sq = age*age)\n\nFirst plot the data to see what we are trying to estimate (how length relates to age):\n\n# Plot length vs age, we'll use a polynomial to account for the curvature\nggplot(d, aes(age, length)) + \n  geom_point() + \n  stat_smooth(method = \"lm\", formula = y ~ poly(x, 2))\n\n\n\n\nNow we can fit a model of length as a function of age (and a squared term just because it isn’t exactly linear in this age-range).\n\n# First a simple lm\nm <- lm(length ~ age + age_sq, data = d)\n\nsummary(m)\n\n\nCall:\nlm(formula = length ~ age + age_sq, data = d)\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-4.3148 -0.9154 -0.0156  0.8760  3.7220 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept)  1.21080    0.42298   2.863  0.00456 ** \nage          5.80080    0.32234  17.996  < 2e-16 ***\nage_sq      -0.39600    0.05271  -7.513 1.06e-12 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 1.395 on 247 degrees of freedom\nMultiple R-squared:  0.9256,    Adjusted R-squared:  0.925 \nF-statistic:  1536 on 2 and 247 DF,  p-value: < 2.2e-16\n\n\nThe residuals look nice! Or?\n\n# Extract residuals\nd$res_m <- residuals(m)\n\n# Plot!\nggplot(d, aes(res_m)) + \n  geom_histogram() + \n  labs(x = \"residuals simple linear regression\")\n\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n\n\n\n\n\nIf we group them by individual fish we see something…\n\nggplot(d, aes(ID, res_m, color = ID)) + \n  geom_boxplot() +  \n  guides(color = \"none\") +\n  theme(axis.text.x = element_text(angle = 90)) + \n  geom_hline(yintercept = 0, linetype = 2, color = \"tomato3\") + \n  labs(y = \"residuals from random slope and intercept model\")\n\n\n\n\nMany boxes do not really overlap 0 when grouped by individual like this. Observations within an individual tend to all be above or below the average! As an example, we can plot the average size at age 1 for two groups: individuals that are below and above the mean size when they are age 5. We see that individuals that are bigger when 5 years where also on average bigger as 1 year olds.\n\nd5 <- d %>% \n  filter(age == 5) %>% \n  mutate(mean_length = mean(length)) %>% \n  mutate(big_ind = ifelse(length > mean_length, \"Yes\", \"No\")) %>% \n  dplyr::select(big_ind, ID)\n\nd %>% left_join(d5, by = \"ID\") %>% \n  filter(age == 1) %>% \n  ggplot(aes(big_ind, length)) + \n  geom_boxplot(width = 0.2, fill = NA) + \n  geom_jitter(height = 0, width = 0.1) + \n  labs(x = \"bigger than average as a 5 year old?\")\n\n\n\n\nHow to deal with this? We can let the variable ID interact with age. This gives every individual a unique slope and intercept.\n\n# First a simple lm\nm2 <- lm(length ~ age*ID + age_sq, data = d)\n\n# Extract residuals\nd$res_m2 <- residuals(m2)\n\n# Make data long for plotting\nd %>% \n  pivot_longer(c(res_m, res_m2)) %>% \n  mutate(name2 = ifelse(name == \"res_m\", \"No ID effect\", \"Age*ID interaction\")) %>% \n  ggplot(aes(ID, value, color = ID)) + \n  facet_wrap(~name2, ncol = 1) +\n  geom_boxplot() +  \n  guides(color = \"none\") +\n  theme(axis.text.x = element_text(angle = 90)) + \n  geom_hline(yintercept = 0, linetype = 2, color = \"tomato3\")\n\n\n\n\nWhile the issues with the residuals got “fixed”, it wasn’t cheap. Just look at the summary table:\n\nsummary(m2)\n\n\nCall:\nlm(formula = length ~ age * ID + age_sq, data = d)\n\nResiduals:\n   Min     1Q Median     3Q    Max \n-2.132 -0.428  0.013  0.411  1.432 \n\nCoefficients:\n                Estimate Std. Error t value Pr(>|t|)    \n(Intercept)       0.3080     0.7584   0.406 0.685236    \nage               6.3160     0.2728  23.149  < 2e-16 ***\nID1987346FM      -0.5900     1.0399  -0.567 0.571340    \nID1987347FM       3.5900     1.0399   3.452 0.000724 ***\nID1987348FM       1.5800     1.0399   1.519 0.130805    \nID1987353FM       1.2500     1.0399   1.202 0.231278    \nID1987354FM       0.5600     1.0399   0.538 0.591044    \nID1987360FM       2.6400     1.0399   2.539 0.012157 *  \nID1987365FM       1.8700     1.0399   1.798 0.074176 .  \nID1987376FM       0.4000     1.0399   0.385 0.701057    \nID1987383FM       0.7900     1.0399   0.760 0.448663    \nID1987389FM       2.0200     1.0399   1.942 0.053974 .  \nID1987390FM      -0.6000     1.0399  -0.577 0.564843    \nID1987393FM       1.0300     1.0399   0.990 0.323569    \nID1987399FM       2.4800     1.0399   2.385 0.018350 *  \nID1987403FM       0.1400     1.0399   0.135 0.893093    \nID1987404FM       0.7600     1.0399   0.731 0.466046    \nID1987407FM       0.9000     1.0399   0.865 0.388196    \nID1987412FM       0.5600     1.0399   0.538 0.591044    \nID1987420FM       0.9600     1.0399   0.923 0.357437    \nID1987423FM       1.5900     1.0399   1.529 0.128405    \nID1987429FM       3.6500     1.0399   3.510 0.000593 ***\nID1987440FM       2.0700     1.0399   1.990 0.048367 *  \nID1987445FM       0.8600     1.0399   0.827 0.409581    \nID1987449FM       1.0700     1.0399   1.029 0.305196    \nID1987451FM       2.8200     1.0399   2.712 0.007482 ** \nID1987452FM       0.6600     1.0399   0.635 0.526633    \nID1987453FM       0.7700     1.0399   0.740 0.460210    \nID1987458FM      -0.5100     1.0399  -0.490 0.624567    \nID1987464FM      -1.7200     1.0399  -1.654 0.100248    \nID1987465FM       1.3600     1.0399   1.308 0.192971    \nID1987470FM      -0.2200     1.0399  -0.212 0.832748    \nID1987476FM       0.2300     1.0399   0.221 0.825267    \nID1987482FM       0.2700     1.0399   0.260 0.795509    \nID1987485FM       0.5300     1.0399   0.510 0.611058    \nID1987492FM      -1.0600     1.0399  -1.019 0.309722    \nID1987493FM      -0.2300     1.0399  -0.221 0.825267    \nID1987494FM       0.9100     1.0399   0.875 0.382959    \nID1987498FM      -0.5100     1.0399  -0.490 0.624567    \nID1987499FM      -0.3800     1.0399  -0.365 0.715329    \nID1987529FM      -0.4600     1.0399  -0.442 0.658893    \nID1987530FM       1.1400     1.0399   1.096 0.274757    \nID1987532FM      -0.6600     1.0399  -0.635 0.526633    \nID1987535FM       0.2000     1.0399   0.192 0.847756    \nID1987539FM       1.9000     1.0399   1.827 0.069699 .  \nID1987545FM      -0.1900     1.0399  -0.183 0.855281    \nID1987567FM       1.3900     1.0399   1.337 0.183390    \nID1987579FM      -0.4600     1.0399  -0.442 0.658893    \nID1988310FM       1.5700     1.0399   1.510 0.133241    \nID1988317FM       4.4700     1.0399   4.298 3.09e-05 ***\nID1988337FM       3.7400     1.0399   3.596 0.000438 ***\nage_sq           -0.3960     0.0265 -14.943  < 2e-16 ***\nage:ID1987346FM  -0.0900     0.3136  -0.287 0.774489    \nage:ID1987347FM  -1.1100     0.3136  -3.540 0.000534 ***\nage:ID1987348FM  -0.3600     0.3136  -1.148 0.252760    \nage:ID1987353FM  -0.5500     0.3136  -1.754 0.081475 .  \nage:ID1987354FM  -0.2000     0.3136  -0.638 0.524555    \nage:ID1987360FM  -1.3400     0.3136  -4.274 3.42e-05 ***\nage:ID1987365FM  -0.6700     0.3136  -2.137 0.034249 *  \nage:ID1987376FM   0.0200     0.3136   0.064 0.949227    \nage:ID1987383FM  -0.0100     0.3136  -0.032 0.974601    \nage:ID1987389FM  -0.9600     0.3136  -3.062 0.002612 ** \nage:ID1987390FM   0.0400     0.3136   0.128 0.898662    \nage:ID1987393FM  -0.3700     0.3136  -1.180 0.239877    \nage:ID1987399FM  -0.2000     0.3136  -0.638 0.524555    \nage:ID1987403FM  -0.5000     0.3136  -1.595 0.112919    \nage:ID1987404FM  -0.4000     0.3136  -1.276 0.204052    \nage:ID1987407FM   0.0200     0.3136   0.064 0.949227    \nage:ID1987412FM  -0.3200     0.3136  -1.021 0.309122    \nage:ID1987420FM  -0.7800     0.3136  -2.488 0.013963 *  \nage:ID1987423FM  -0.6100     0.3136  -1.945 0.053607 .  \nage:ID1987429FM  -1.0500     0.3136  -3.349 0.001028 ** \nage:ID1987440FM  -0.0100     0.3136  -0.032 0.974601    \nage:ID1987445FM  -0.8000     0.3136  -2.551 0.011738 *  \nage:ID1987449FM  -0.7100     0.3136  -2.264 0.024996 *  \nage:ID1987451FM  -0.7000     0.3136  -2.232 0.027077 *  \nage:ID1987452FM  -0.9000     0.3136  -2.870 0.004698 ** \nage:ID1987453FM  -0.1700     0.3136  -0.542 0.588514    \nage:ID1987458FM  -0.1900     0.3136  -0.606 0.545469    \nage:ID1987464FM   0.3800     0.3136   1.212 0.227468    \nage:ID1987465FM  -0.3800     0.3136  -1.212 0.227468    \nage:ID1987470FM  -0.2000     0.3136  -0.638 0.524555    \nage:ID1987476FM   0.1500     0.3136   0.478 0.633079    \nage:ID1987482FM  -0.8300     0.3136  -2.647 0.008993 ** \nage:ID1987485FM  -0.5100     0.3136  -1.626 0.105956    \nage:ID1987492FM  -0.1000     0.3136  -0.319 0.750233    \nage:ID1987493FM  -0.4700     0.3136  -1.499 0.136007    \nage:ID1987494FM  -0.4900     0.3136  -1.563 0.120241    \nage:ID1987498FM  -0.4300     0.3136  -1.371 0.172324    \nage:ID1987499FM  -0.5000     0.3136  -1.595 0.112919    \nage:ID1987529FM  -0.9200     0.3136  -2.934 0.003875 ** \nage:ID1987530FM  -0.8800     0.3136  -2.807 0.005678 ** \nage:ID1987532FM  -0.4600     0.3136  -1.467 0.144473    \nage:ID1987535FM  -0.6600     0.3136  -2.105 0.036980 *  \nage:ID1987539FM  -0.7400     0.3136  -2.360 0.019570 *  \nage:ID1987545FM  -0.7500     0.3136  -2.392 0.018008 *  \nage:ID1987567FM  -0.6900     0.3136  -2.201 0.029307 *  \nage:ID1987579FM  -0.6800     0.3136  -2.169 0.031695 *  \nage:ID1988310FM  -0.5500     0.3136  -1.754 0.081475 .  \nage:ID1988317FM  -1.1900     0.3136  -3.795 0.000214 ***\nage:ID1988337FM  -1.9400     0.3136  -6.187 5.63e-09 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 0.7011 on 149 degrees of freedom\nMultiple R-squared:  0.9887,    Adjusted R-squared:  0.981 \nF-statistic: 129.8 on 100 and 149 DF,  p-value: < 2.2e-16\n\n\nThat’s a lot parameters to estimate, and it’s not even parameters we are interested in! We just wanted to fix the residual issues. We are seeking the average intercept and slope in this population, not the intercept and slope of each fish.\nEnter random effects! There are a few different reasons for why you would want to model effects as random factors. Here’s a more thorough example on the topic. In our case, we just want to control for systematic variation from our use of multiple data points per individual.\nWe consider two cases here: (1) within ID’s, there’s a negative correlation between intercept and slope and (2) intercepts and slopes vary among individuals (see the (x|ID) addition). We fit these using the lme4 package.\n\n# Random intercept only\nm3 <- lmer(length ~ age + age_sq + (1|ID), data = d)\n\n# Random intercept and slope\nm4 <- lmer(length ~ age + age_sq + (1 + age|ID), data = d)\n\n# We can compare them with AIC. Random intercept is more parsimonious\nAIC(m3, m4)\n\n   df      AIC\nm3  5 781.4218\nm4  7 739.4287\n\n\nThere seems to be support for both intercepts and age slopes to vary among individuals based on AIC. We can now have a look at the model:\n\n# Inspect the model\nsummary(m4)\n\nLinear mixed model fit by REML ['lmerMod']\nFormula: length ~ age + age_sq + (1 + age | ID)\n   Data: d\n\nREML criterion at convergence: 725.4\n\nScaled residuals: \n     Min       1Q   Median       3Q      Max \n-3.13579 -0.59883  0.03232  0.64076  1.83217 \n\nRandom effects:\n Groups   Name        Variance Std.Dev. Corr \n ID       (Intercept) 1.2051   1.0977        \n          age         0.1324   0.3639   -0.50\n Residual             0.4916   0.7011        \nNumber of obs: 250, groups:  ID, 50\n\nFixed effects:\n            Estimate Std. Error t value\n(Intercept)   1.2108     0.2633   4.599\nage           5.8008     0.1700  34.115\nage_sq       -0.3960     0.0265 -14.943\n\nCorrelation of Fixed Effects:\n       (Intr) age   \nage    -0.814       \nage_sq  0.705 -0.935\n\n\nHere we see two things: our fixed effects are now our population level estimates, from which each individual deviate, and that the intercept and age slope are very correlated. What about the residuals?\n\n# Extract residuals\nd$res_m4 <- residuals(m4)\n\nggplot(d, aes(ID, res_m4, color = ID)) + \n  geom_boxplot() +  \n  guides(color = \"none\") +\n  theme(axis.text.x = element_text(angle = 90)) + \n  geom_hline(yintercept = 0, linetype = 2, color = \"tomato3\") + \n  labs(y = \"residuals from random slope and intercept model\")\n\n\n\n\nBeautiful! And this is just an example. With the full data set once could further explore adding a fixed effect of area (warm/cold) and different random effect structures and models. But for now, that’s it!"
  },
  {
    "objectID": "posts/random_effects/index.html#fit-models",
    "href": "posts/random_effects/index.html#fit-models",
    "title": "Exemplifying random effects",
    "section": "Fit models!",
    "text": "Fit models!\n\n# First a simple lm\nm <- lm(length ~ age + age_sq, data = d)\n\nsummary(m)\n\n\nCall:\nlm(formula = length ~ age + age_sq, data = d)\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-4.3148 -0.9154 -0.0156  0.8760  3.7220 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept)  1.21080    0.42298   2.863  0.00456 ** \nage          5.80080    0.32234  17.996  < 2e-16 ***\nage_sq      -0.39600    0.05271  -7.513 1.06e-12 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 1.395 on 247 degrees of freedom\nMultiple R-squared:  0.9256,    Adjusted R-squared:  0.925 \nF-statistic:  1536 on 2 and 247 DF,  p-value: < 2.2e-16\n\n# Extract residuals\nd$res_lm <- residuals(m)\n\nggplot(d, aes(res_lm)) + \n  geom_histogram()\n\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n\n\n\n\n\nThey look nice! Or?\n\nggplot(d, aes(ID, res_lm, color = ID)) + \n  geom_boxplot() +  \n  guides(color = \"none\") +\n  theme(axis.text.x = element_text(angle = 90)) + \n  geom_hline(yintercept = 0, linetype = 2, color = \"tomato3\")\n\n\n\n\nIt seems that many boxes do not really overlap 0 when grouped by individual like this. Observations within an individual tend to all be above or below the average! We can plot this\n\nd5 <- d %>% \n  filter(age == 5) %>% \n  mutate(mean_length = mean(length)) %>% \n  mutate(big_ind = ifelse(length > mean_length, \"Y\", \"N\")) %>% \n  dplyr::select(big_ind, ID)\n\nd %>% left_join(d5, by = \"ID\") %>% \n  filter(age == 1) %>% \n  ggplot(aes(big_ind, length)) + \n  geom_boxplot(width = 0.2, fill = NA) + \n  geom_jitter(height = 0, width = 0.1) + \n  labs(x = \"Bigger than average as a 5 year old?\")\n\n\n\n\n\nggplot(d, aes(ID, res_lm, color = ID)) + \n  geom_boxplot() +  \n  guides(color = \"none\") +\n  theme(axis.text.x = element_text(angle = 90)) + \n  geom_hline(yintercept = 0, linetype = 2, color = \"tomato3\")\n\n\n\n\nHow to deal with this? We can add an ID effect (both intercept and slope)\n\n# First a simple lm\nm2 <- lm(length ~ age*ID + age_sq, data = d)\n\nsummary(m2)\n\n\nCall:\nlm(formula = length ~ age * ID + age_sq, data = d)\n\nResiduals:\n   Min     1Q Median     3Q    Max \n-2.132 -0.428  0.013  0.411  1.432 \n\nCoefficients:\n                Estimate Std. Error t value Pr(>|t|)    \n(Intercept)       0.3080     0.7584   0.406 0.685236    \nage               6.3160     0.2728  23.149  < 2e-16 ***\nID1987346FM      -0.5900     1.0399  -0.567 0.571340    \nID1987347FM       3.5900     1.0399   3.452 0.000724 ***\nID1987348FM       1.5800     1.0399   1.519 0.130805    \nID1987353FM       1.2500     1.0399   1.202 0.231278    \nID1987354FM       0.5600     1.0399   0.538 0.591044    \nID1987360FM       2.6400     1.0399   2.539 0.012157 *  \nID1987365FM       1.8700     1.0399   1.798 0.074176 .  \nID1987376FM       0.4000     1.0399   0.385 0.701057    \nID1987383FM       0.7900     1.0399   0.760 0.448663    \nID1987389FM       2.0200     1.0399   1.942 0.053974 .  \nID1987390FM      -0.6000     1.0399  -0.577 0.564843    \nID1987393FM       1.0300     1.0399   0.990 0.323569    \nID1987399FM       2.4800     1.0399   2.385 0.018350 *  \nID1987403FM       0.1400     1.0399   0.135 0.893093    \nID1987404FM       0.7600     1.0399   0.731 0.466046    \nID1987407FM       0.9000     1.0399   0.865 0.388196    \nID1987412FM       0.5600     1.0399   0.538 0.591044    \nID1987420FM       0.9600     1.0399   0.923 0.357437    \nID1987423FM       1.5900     1.0399   1.529 0.128405    \nID1987429FM       3.6500     1.0399   3.510 0.000593 ***\nID1987440FM       2.0700     1.0399   1.990 0.048367 *  \nID1987445FM       0.8600     1.0399   0.827 0.409581    \nID1987449FM       1.0700     1.0399   1.029 0.305196    \nID1987451FM       2.8200     1.0399   2.712 0.007482 ** \nID1987452FM       0.6600     1.0399   0.635 0.526633    \nID1987453FM       0.7700     1.0399   0.740 0.460210    \nID1987458FM      -0.5100     1.0399  -0.490 0.624567    \nID1987464FM      -1.7200     1.0399  -1.654 0.100248    \nID1987465FM       1.3600     1.0399   1.308 0.192971    \nID1987470FM      -0.2200     1.0399  -0.212 0.832748    \nID1987476FM       0.2300     1.0399   0.221 0.825267    \nID1987482FM       0.2700     1.0399   0.260 0.795509    \nID1987485FM       0.5300     1.0399   0.510 0.611058    \nID1987492FM      -1.0600     1.0399  -1.019 0.309722    \nID1987493FM      -0.2300     1.0399  -0.221 0.825267    \nID1987494FM       0.9100     1.0399   0.875 0.382959    \nID1987498FM      -0.5100     1.0399  -0.490 0.624567    \nID1987499FM      -0.3800     1.0399  -0.365 0.715329    \nID1987529FM      -0.4600     1.0399  -0.442 0.658893    \nID1987530FM       1.1400     1.0399   1.096 0.274757    \nID1987532FM      -0.6600     1.0399  -0.635 0.526633    \nID1987535FM       0.2000     1.0399   0.192 0.847756    \nID1987539FM       1.9000     1.0399   1.827 0.069699 .  \nID1987545FM      -0.1900     1.0399  -0.183 0.855281    \nID1987567FM       1.3900     1.0399   1.337 0.183390    \nID1987579FM      -0.4600     1.0399  -0.442 0.658893    \nID1988310FM       1.5700     1.0399   1.510 0.133241    \nID1988317FM       4.4700     1.0399   4.298 3.09e-05 ***\nID1988337FM       3.7400     1.0399   3.596 0.000438 ***\nage_sq           -0.3960     0.0265 -14.943  < 2e-16 ***\nage:ID1987346FM  -0.0900     0.3136  -0.287 0.774489    \nage:ID1987347FM  -1.1100     0.3136  -3.540 0.000534 ***\nage:ID1987348FM  -0.3600     0.3136  -1.148 0.252760    \nage:ID1987353FM  -0.5500     0.3136  -1.754 0.081475 .  \nage:ID1987354FM  -0.2000     0.3136  -0.638 0.524555    \nage:ID1987360FM  -1.3400     0.3136  -4.274 3.42e-05 ***\nage:ID1987365FM  -0.6700     0.3136  -2.137 0.034249 *  \nage:ID1987376FM   0.0200     0.3136   0.064 0.949227    \nage:ID1987383FM  -0.0100     0.3136  -0.032 0.974601    \nage:ID1987389FM  -0.9600     0.3136  -3.062 0.002612 ** \nage:ID1987390FM   0.0400     0.3136   0.128 0.898662    \nage:ID1987393FM  -0.3700     0.3136  -1.180 0.239877    \nage:ID1987399FM  -0.2000     0.3136  -0.638 0.524555    \nage:ID1987403FM  -0.5000     0.3136  -1.595 0.112919    \nage:ID1987404FM  -0.4000     0.3136  -1.276 0.204052    \nage:ID1987407FM   0.0200     0.3136   0.064 0.949227    \nage:ID1987412FM  -0.3200     0.3136  -1.021 0.309122    \nage:ID1987420FM  -0.7800     0.3136  -2.488 0.013963 *  \nage:ID1987423FM  -0.6100     0.3136  -1.945 0.053607 .  \nage:ID1987429FM  -1.0500     0.3136  -3.349 0.001028 ** \nage:ID1987440FM  -0.0100     0.3136  -0.032 0.974601    \nage:ID1987445FM  -0.8000     0.3136  -2.551 0.011738 *  \nage:ID1987449FM  -0.7100     0.3136  -2.264 0.024996 *  \nage:ID1987451FM  -0.7000     0.3136  -2.232 0.027077 *  \nage:ID1987452FM  -0.9000     0.3136  -2.870 0.004698 ** \nage:ID1987453FM  -0.1700     0.3136  -0.542 0.588514    \nage:ID1987458FM  -0.1900     0.3136  -0.606 0.545469    \nage:ID1987464FM   0.3800     0.3136   1.212 0.227468    \nage:ID1987465FM  -0.3800     0.3136  -1.212 0.227468    \nage:ID1987470FM  -0.2000     0.3136  -0.638 0.524555    \nage:ID1987476FM   0.1500     0.3136   0.478 0.633079    \nage:ID1987482FM  -0.8300     0.3136  -2.647 0.008993 ** \nage:ID1987485FM  -0.5100     0.3136  -1.626 0.105956    \nage:ID1987492FM  -0.1000     0.3136  -0.319 0.750233    \nage:ID1987493FM  -0.4700     0.3136  -1.499 0.136007    \nage:ID1987494FM  -0.4900     0.3136  -1.563 0.120241    \nage:ID1987498FM  -0.4300     0.3136  -1.371 0.172324    \nage:ID1987499FM  -0.5000     0.3136  -1.595 0.112919    \nage:ID1987529FM  -0.9200     0.3136  -2.934 0.003875 ** \nage:ID1987530FM  -0.8800     0.3136  -2.807 0.005678 ** \nage:ID1987532FM  -0.4600     0.3136  -1.467 0.144473    \nage:ID1987535FM  -0.6600     0.3136  -2.105 0.036980 *  \nage:ID1987539FM  -0.7400     0.3136  -2.360 0.019570 *  \nage:ID1987545FM  -0.7500     0.3136  -2.392 0.018008 *  \nage:ID1987567FM  -0.6900     0.3136  -2.201 0.029307 *  \nage:ID1987579FM  -0.6800     0.3136  -2.169 0.031695 *  \nage:ID1988310FM  -0.5500     0.3136  -1.754 0.081475 .  \nage:ID1988317FM  -1.1900     0.3136  -3.795 0.000214 ***\nage:ID1988337FM  -1.9400     0.3136  -6.187 5.63e-09 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 0.7011 on 149 degrees of freedom\nMultiple R-squared:  0.9887,    Adjusted R-squared:  0.981 \nF-statistic: 129.8 on 100 and 149 DF,  p-value: < 2.2e-16\n\n# Extract residuals\nd$res_lm2 <- residuals(m2)\n\n# Make data long for plotting\nd %>% \n  pivot_longer(c(res_lm, res_lm2)) %>% \n  mutate(name2 = ifelse(name == \"res_lm\", \"No ID effect\", \"Age*ID interaction\")) %>% \n  ggplot(aes(ID, value, color = ID)) + \n  facet_wrap(~name2, ncol = 1) +\n  geom_boxplot() +  \n  guides(color = \"none\") +\n  theme(axis.text.x = element_text(angle = 90)) + \n  geom_hline(yintercept = 0, linetype = 2, color = \"tomato3\") + \n  ggtitle(\"Age x ID interaction\")"
  },
  {
    "objectID": "posts/vbge_ode/index.html",
    "href": "posts/vbge_ode/index.html",
    "title": "Fitting a Pütter/von Bertalanffy ODE in brms",
    "section": "",
    "text": "The Pütter growth model (Pütter 1920) states that growth is the result of tissue synthesis (“anabolism”) and tissue breakdown (“catabolism”), expressed in the formula:\n\\[dW/dt=aW^y-bW^z\\] In the 1930’s, Ludwig von Bertalanffy published a series of papers (1932, 1934 and 1938. 1938 also happens to be the year he joined the Nazi party). In these, he introduced assumptions based on geometry that much simplified the solution of the Pütter model. Specifically, \\(z=1\\)1. This allowed him to easily recast the Pütter ODE in terms of weight as a function of time (this is the version in (2001)):\n\\[W_t=W_\\infty(1-\\exp(-K_{sp}(t-t_0)))^3\\] In other words, the von Bertalanffy equation (VBGE) is a special case of the Pütter model, where catabolism is proportional to mass.\nAn even more special version of this model is the specialized von Bertalanffy equation (Beverton and Holt 1957; Pauly 1981; Ursin 1967). By also assuming that \\(W\\propto L^3\\) and that \\(b=2/3\\), you can cast this as a model of length (which in easier to measure in a fish while on a boat):\n\\[L_t=L_\\infty(1-\\exp(-K(t-t_0)))\\] And this is the version most fisheries biologists are familiar with. It’s the most common model for describing length as a function of age, very likely because it was adopted by Beverton and Holt (1957). von Bertalanffy (1957) writes:\n“It appears that the ”Bertalanffy growth equation” is widely applied in international fisheries. It has been found to fit the commercially exploited fish species studied by the Fisheries Laboratory of the Ministry of Agriculture, Fisheries and Food at Lowestoft (England), with the possible exception of the hake (Wimpenny, pers. commun.)”2\nNow, \\(b=2/3\\) stems originally from the “surface rule” (Rubner 1902), basically stating that since a (body) surface scales with a 2/3 power to the volume, and heat loss is proportional to the body surface, and because each each calorie must be replaced to maintain a fixed temperature (37°), “production” is proportional to \\(W^{2/3}\\). This doesn’t apply to ectotherms, such as fish, and in those cases the 2/3 exponent is argued to be close to the exponent of standard metabolic rate (even though we know now it’s closer to 0.8 (e.g., Clarke and Johnston 1999; Jerde et al. 2019; Lindmark, Ohlberger, and Gårdmark 2022). Or, as Pauly suggests in his Gill-Oxygen Limitation Theory (GOLT): the exponent \\(y\\) reflects the scaling of gill surface area in relation to weight, such that as ectotherms growh in size, they increasingly struggle to meet oxygen demands which scale in proportion to mass.\nOk, ok, enough background. The point is this: sometimes you want the parameters \\(a\\) and \\(b\\) rather than \\(W_\\infty\\), \\(t_0\\), and \\(K_{sp}\\). You can convert between them though; \\(K_{sp}=b/3\\) and \\(W_\\infty=(a/b)^{1/(1–y)}\\) (Essington, Kitchell, and Walters 2001). But note! This is only legal when you make the assumptions above! And you may not always want that. Maybe you want to estimate \\(a\\) and \\(b\\) from data instead. And why not \\(y\\) and \\(z\\) when you are at it? Maybe you don’t buy the arguments for the mechanistic basis of these parameters and want to take an empirical approach to fitting the Pütter model. Maybe you want to extend or modify the Pütter model, as in e.g., Marshall & White (2019) or Thunell et al., (n.d.). And lastly, you may want the full uncertainty on \\(a\\) and \\(b\\) directly, e.g., via a posterior distribution.\nBelow I show how we can fit the Pütter ODE model to data using brms. As in the last post, we will use the perch (Perca fluviatilis) data set containing back-calculated length-at-age. First we’ll load, filter, and plot the data:\nAs can be seen, we have multiple observations per individual, and they either fast or slow growers. This will cause some unwanted residuals patterns unless accounted for, so we will allow the Pütter parameters to vary by individual (ID as random effect). Below I define the model. I’m using the simple exponential decay model in this Stan forum post as a template for aunivariate ODE, but I’ve also read up on the Lotka-Volterra competition model in brms from Mage’s blog and Solomon Kurz’s brms-translation of Statistical Rethinking. For speed (it still takes a solid 8h to fit this model!) I use only the first 100 individuals in the data set (there are 12786!!!), and I only estimate \\(a\\) and \\(b\\), while setting \\(y=2/3\\) and \\(z=1\\). In theory, one could add nested random effects (ID within cohorts for instance), or let the standard deviation vary with time."
  },
  {
    "objectID": "test.html",
    "href": "test.html",
    "title": "Untitled",
    "section": "",
    "text": "1+1\n\n[1] 2"
  },
  {
    "objectID": "TESTING.html",
    "href": "TESTING.html",
    "title": "Untitled",
    "section": "",
    "text": "hello\nThe Pütter growth model (Pütter, 1920) states that growth is the result of tissue synthesis and tissue breakdown, expressed in the formula:\n\\[dW/dt=aW^y-bW^z\\]\n“It appears that the “Bertalanffy growth equation” is widely applied in international fisheries. It has been found to fit the commercially exploited fish species studied by the Fisheries Laboratory of the Ministry of Agriculture, Fisheries and Food at Lowestoft (England), with the possible exception of the hake (Wimpenny, pers. commun.) (Pütter 1920)\nadopted by Beverton and Holt (1957):\nAnd this is the version most fisheries biologists are familiar with. It’s the most common model for describing length as a function of age, very likely because it was adopted by Beverton and Holt (1957):\n“It appears that the ”Bertalanffy growth equation” is widely applied in international fisheries. It has been found to fit the commercially exploited fish species studied by the Fisheries Laboratory of the Ministry of Agriculture, Fisheries and Food at Lowestoft (England), with the possible exception of the hake (Wimpenny, pers. commun.)” 1\n- in von Bertalanffy (1957)\nthe arguments for the mechanistic basis of these parameters and want to take an empirical approach to fitting the Pütter model. Maybe you want to extend or modify the Pütter model, as in e.g., Marshall & White (2019) or Thunell et al., (n.d.).\n\nReferences\n\n::: {#further reading} ::: ### Further reading on von Bertalnffy and GOLT\n\nGlobal Change Biology\nLefevre, S., McKenzie, D. J., and Nilsson, G. E. 2017. Models projecting the fate of fish populations under climate change need to be based on valid physiological mechanisms. Global Change Biology, 23: 3449–3459.\nPauly, D., and Cheung, W. W. L. 2018. Sound physiological knowledge and principles in modeling shrinking of fishes under climate change. Global Change Biology, 24: e15–e26.\nLefevre, S., McKenzie, D. J., and Nilsson, G. E. 2018. In modelling effects of global warming, invalid assumptions lead to unrealistic projections. Global Change Biology, 24: 553–556.\nPauly, D., and Cheung, W. W. L. 2018. On confusing cause and effect in the oxygen limitation of fish. Global Change Biology, 24: e743–e744.\n\n\nTrends in Ecology and Evolution\nMarshall, D. J., and White, C. R. 2019. Have we outgrown the existing models of growth? Trends in Ecology & Evolution, 34: 102–111.\nPauly, D. 2019. Female Fish Grow Bigger – Let’s Deal with It. Trends in Ecology & Evolution, 34, 3\nMarshall, D. J., and White, C. R. 2019. Aquatic life history trajectories are shaped by selection, not oxygen limitation. Trends in Ecology & Evolution, 34: 182–184.\n\n\n\n\n\n\nReferences\n\nBeverton, Raymond J. H., and Sidney J. Holt. 1957. On the Dynamics of Exploited Fish Populations. Fishery Investigations London Series 2, Volume 19.\n\n\nMarshall, Dustin J., and Craig R. White. 2019. “Have We Outgrown the Existing Models of Growth?” Trends in Ecology & Evolution 34 (2): 102–11. https://doi.org/10.1016/j.tree.2018.10.005.\n\n\nPütter, August. 1920. “Studien über physiologische Ähnlichkeit VI. Wachstumsähnlichkeiten.” Pflügers Arch. 180 (1): 298–340. https://doi.org/10.1007/BF01755094.\n\n\nThunell, Viktor, Anna Gårdmark, Magnus Huss, and Yngvild Vindenes. n.d. “Optimal Energy Allocation Trade-Off Driven by Size-Dependent Physiological and Demographic Responses to Warming.” Ecology n/a (n/a): e3967. https://doi.org/10.1002/ecy.3967.\n\n\nvon Bertalanffy, L. 1957. “Laws in Metabolism and Growth.” The Quarterly Review of Biology 32 (3): 217–31.\n\nFootnotes\n\n\nI’m sure someone has since succeeded in fitting a VBGE for hake!↩︎"
  },
  {
    "objectID": "TESTING.html#references",
    "href": "TESTING.html#references",
    "title": "Untitled",
    "section": "References",
    "text": "References"
  },
  {
    "objectID": "posts/vbge_ode/index.html#a-pütter-ode-model-in-brms",
    "href": "posts/vbge_ode/index.html#a-pütter-ode-model-in-brms",
    "title": "Fitting a Pütter/von Bertalanffy ODE in brms",
    "section": "A Pütter ODE model in brms",
    "text": "A Pütter ODE model in brms\n\n# Using this exponential decay model as a template:\n# https://discourse.mc-stan.org/t/new-cmdstan-ode-solvers-and-brms/24173\n\n# Simple vbge model\nvb_model <- \"\n  real[] ode_vb(real t, //time\n  real [] w,         // the rates\n  real [] theta,     // the parameters\n  real [] x_r,       // data constant (not used)\n  int[] x_i){        // data constant (not used)\n  real dwdt[1];      // dimension of ODEs\n\n  dwdt[1] = theta[1]*w[1]^(0.67) - theta[2]*w[1]^1; // growth ODE\n\n  return dwdt;       // returns a 3-dimensional array     \n\n  }\n\n// this is the function call from brms, integration of ODEs:\nreal vb_ode(real t, real weight0, real a, real b) {\n  real w0[1]; //one initial value\n  real theta[2]; \n  real w[1,1]; //ODE solution\n  w0[1] = weight0; //initial values\n  theta[1] = a; \n  theta[2] = b; \n\n  w = integrate_ode_rk45(ode_vb,\n                         w0,\n                         0,\n                         rep_array(t, 1),\n                         theta,\n                         rep_array(0.0,0),\n                         rep_array(1,1),\n                         0.00001,0.00001,100);\n// Return relevant values\n    return(w[1,1]);\n}\n\n\"\n\nvb_formula <- bf(w ~ vb_ode(t, weight0, a, b),\n                 weight0 ~ 1,\n                 a ~ 1 + (1|ID),\n                 b ~ 1 + (1|ID),\n                 nl = TRUE)\n\n# This priors could be discussed...\nvb_priors <- c(prior(normal(0.00001, 1), nlpar = weight0, lb = 0.00001),\n               prior(normal(1, 1), nlpar = a, lb = 0.00001),\n               prior(normal(0.5, 1), nlpar = b, lb = 0.00001),\n               prior(cauchy(0, 10), class = sigma))\n\nNow that all functions have been defined, we can feed that into the brm function. I use a Lognormal distribution to ensure we don’t predict negative weights.\n\n# startTime <- Sys.time()\nvb_fit <- brm(data = d,\n              family = lognormal(),\n              formula = vb_formula,\n              prior = vb_priors,\n              init = 0,\n              iter = 4000,\n              chains = 3,\n              cores = 3,\n              backend = \"cmdstanr\",\n              control = list(adapt_delta = 0.9),\n              stanvars = stanvar(scode = vb_model, block = \"functions\"),\n              sample_prior = \"yes\")\n# endTime <- Sys.time()\n# endTime - startTime\n# \n# saveRDS(vb_fit, \"posts/vbge_ode/vb_fit.rds\")\n\nWe can now check our model summary and plot it to inspect posteriors and chain convergence:\n\n# Check the model!\nsummary(vb_fit)\n\n Family: lognormal \n  Links: mu = identity; sigma = identity \nFormula: w ~ vb_ode(t, weight0, a, b) \n         weight0 ~ 1\n         a ~ 1 + (1 | ID)\n         b ~ 1 + (1 | ID)\n   Data: d (Number of observations: 900) \n  Draws: 3 chains, each with iter = 4000; warmup = 2000; thin = 1;\n         total post-warmup draws = 6000\n\nGroup-Level Effects: \n~ID (Number of levels: 100) \n                Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS\nsd(a_Intercept)     0.06      0.01     0.05     0.07 1.00      897     1736\nsd(b_Intercept)     0.01      0.01     0.00     0.02 1.01      281      463\n\nPopulation-Level Effects: \n                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS\nweight0_Intercept     0.41      0.03     0.35     0.47 1.00     2691     3823\na_Intercept           2.35      0.05     2.25     2.44 1.00     2497     3598\nb_Intercept           1.33      0.03     1.27     1.39 1.00     2672     3635\n\nFamily Specific Parameters: \n      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS\nsigma     0.30      0.01     0.29     0.32 1.00     6809     4077\n\nDraws were sampled using sample(hmc). For each parameter, Bulk_ESS\nand Tail_ESS are effective sample size measures, and Rhat is the potential\nscale reduction factor on split chains (at convergence, Rhat = 1).\n\nplot(vb_fit, N=6)\n\n\n\n\nLooks fine! Let’s do some data wrangling and plot prior vs posterior (note we can do this because we set sample_prior = \"yes\").\n\ndraws <- brms::as_draws_df(vb_fit) %>%\n  dplyr::select(b_weight0_Intercept, b_a_Intercept, b_b_Intercept, \n                prior_b_weight0, prior_b_a, prior_b_b) %>%\n  pivot_longer(cols = everything()) %>%\n  mutate(group = ifelse(grepl(\"prior\", name), \"Prior\", \"Posterior\")) %>% \n  mutate(Parameter = str_remove(name, pattern = \"_Intercept\"),\n         Parameter = str_remove(Parameter, pattern = \"prior_\"))\n\nhead(draws)\n\n# A tibble: 6 × 4\n  name                value group     Parameter\n  <chr>               <dbl> <chr>     <chr>    \n1 b_weight0_Intercept 0.458 Posterior b_weight0\n2 b_a_Intercept       2.30  Posterior b_a      \n3 b_b_Intercept       1.30  Posterior b_b      \n4 prior_b_weight0     0.255 Prior     b_weight0\n5 prior_b_a           1.77  Prior     b_a      \n6 prior_b_b           0.517 Prior     b_b      \n\n# Plot prior vs posteriors\nggplot(draws) +\n  geom_density(aes(x = value, fill = group), alpha = 0.5, color = NA) +\n  facet_wrap(~Parameter, scales = \"free\") + \n  scale_fill_brewer(palette = \"Set1\", name = \"\") +\n  theme(panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank(),\n        legend.position = c(0.85, 0.25)) + \n  labs(x = \"Value\", y = \"Density\")\n\n\n\n\nNow let’s predict from the model onto a new data (just a dataframe with time steps, representing year) and add uncertainty bands.\n\nnd <- data.frame(t = 1:max(d$t))\n\n# We now need to expose the functions to R\nexpose_functions(vb_fit, vectorize = TRUE)\n\npred <- predicted_draws(vb_fit, newdata = nd, ndraws = 1000, re_formula = NA)\n\nggplot(pred, aes(x = as.factor(t), y = w)) +\n  stat_lineribbon(aes(y = .prediction), .width = c(.99, .95, .8, .5), alpha = 0.5) +\n  geom_jitter(data = d, aes(as.factor(t), w), height = 0, alpha = 0.3) +\n  labs(y = \"Weight (g)\", x = \"Time (years)\") +\n  scale_fill_brewer(palette = \"Reds\", name = \"\") + \n  theme(panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank()) +\n  ggtitle(\"Global prediction of weight-at-age\")\n\n\n\n\nWe can also explore the predictions for some of the individuals (first 20 here), and relate that to data and the global prediction. The model seems to have a reasonable global prediction and at the same time a good fit to the individual fish.\n\nnd2 <- data.frame(expand.grid(t = 1:max(d$t),\n                              ID = head(unique(d$ID), 20))) # Use 16 IDs for easier plotting\n\npred2 <- predicted_draws(vb_fit, newdata = nd2, ndraws = 1000)\n\nggplot(pred2, aes(x = as.factor(t), y = w)) +\n  facet_wrap(~ID) +\n  stat_lineribbon(aes(y = .prediction, color = \"ID-prediction\"), .width = c(.99), alpha = 0.8, size = 0.5, fill = \"grey90\") +\n  geom_point(data = d %>% filter(ID %in% head(unique(d$ID), 20)), aes(t, w, color = \"Data\"), size = 0.6) +\n  geom_line(data = pred %>% group_by(t) %>% summarise(median_pred = median(.prediction)),\n            aes(t, median_pred, color = \"Global prediction\"), inherit.aes = FALSE) +\n  scale_color_brewer(palette = \"Set1\", name = \"\") +\n  labs(y = \"Weight (g)\", x = \"Time (years)\") +\n  theme(panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank(),\n        legend.position = \"bottom\") + \n  guides(color = guide_legend(override.aes = list(fill = c(NA, NA, \"grey80\")))) +\n  ggtitle(\"Individual-level and global prediction vs. data\")\n\n\n\n\nWhat is the \\(W_\\infty\\)? We can visualize that by plotting the rates of anabolism and catabolism, and see where they intersect (i.e., where \\(dW/dt=0\\)):\n\npars <- summary(vb_fit)$fixed %>% \n  rownames_to_column() %>% \n  ungroup() %>% \n  mutate(par = str_remove(rowname, pattern = \"_Intercept\")) %>% \n  dplyr::select(par, Estimate) %>% \n  pivot_wider(names_from = par, values_from = Estimate)\n\ndata.frame(mass = log(seq(from = 3, to = 400, by = 0.1))) %>% \n  mutate(Anabolism = pars$a*mass^(2/3),\n         Catabolism = pars$b*mass^1) %>% \n  pivot_longer(c(Anabolism, Catabolism), names_to = \"Rate\") %>% \n  ggplot(aes(exp(mass), value, color = Rate)) + \n  geom_line() + \n  labs(x = \"Mass\", y = \"Rate per year\") + \n  scale_color_brewer(palette = \"Set1\", name = \"\") +\n  ggtitle(\"Anabolism vs. catabolism\") +\n  theme(panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank(),\n        legend.position = c(0.9, 0.1),\n        legend.background = element_rect(fill = NA))\n\n\n\n\nTo wrap it up and link back to the motivation for this model. In my case, I want the parameters \\(a\\) and \\(b\\) with uncertainty and without having to make assumptions about isometric growth or certain scaling exponents. Because with \\(a\\) and \\(b\\) and the Pütter ODE (rhyme not intended), I can for loop change in weight for any time step (e.g., daily if I divide by 365), and I can add things like seasonality (temperature). Here I exemplify the for loop approach and compare it to data, the global predictions and the distribution of \\(W_\\infty\\) that we get from this relation: \\(W_\\infty=(H/k)^{1/(1–d)}\\).\n\nmax_age <- 10\nweight_df <- data.frame(weight = c(pars$weight0, rep(NA, max_age)),\n                        age = c(0:max_age),\n                        anabolism = rep(NA, max_age + 1),\n                        catabolism = rep(NA, max_age + 1),\n                        dw = rep(NA, max_age + 1))\n\nfor(i in 2:nrow(weight_df)){\n  \n  anabolism <- pars$a*weight_df[i-1, \"weight\"]^(2/3)\n  catabolism <- pars$b*weight_df[i-1, \"weight\"]^(1)\n  \n  dw <- anabolism - catabolism\n  \n  weight_df[i, \"anabolism\"] <- anabolism\n  weight_df[i, \"catabolism\"] <- catabolism\n  weight_df[i, \"dw\"] <- dw\n  weight_df[i, \"weight\"] <- weight_df[i-1, \"weight\"] + dw\n  \n}\n\n# Get new prediction with a longer time span to get the asymptote\nnd <- data.frame(t = 1:max_age)\n\n# Predict from the log-normal model\npred <- predicted_draws(vb_fit, newdata = nd, ndraws = 1000, re_formula = NA)\n\n# Let's plot the data, the model prediction and the \"manual\" prediction using the for loops and our parameter estimates.\np1 <- ggplot(d, aes(t, w)) + \n  stat_lineribbon(data = pred, aes(t, .prediction, color = \"Global prediction\"), inherit.aes = FALSE, .width = c(.99, .95, .8, .5), alpha = 0.5) +\n  geom_jitter(height = 0, alpha = 0.5) +  \n  geom_line(data = weight_df, aes(age, exp(weight), color = \"Manual prediction\"), size = 1.1) +\n  scale_color_brewer(palette = \"Set1\", name = \"\") +\n  scale_fill_brewer(palette = \"Reds\", name = \"\") + \n  coord_cartesian(ylim = c(0, 700)) + \n  labs(y = \"Weight (g)\", x = \"Time (years)\") +\n  theme(panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank(),\n        legend.position = c(0.15, 0.95),\n        legend.background = element_rect(fill = NA)) +\n  guides(color = guide_legend(override.aes = list(fill = NA)),\n         fill = \"none\")\n\n# Get w_inf not as a fixed value but as a distribution given the posterior for a and b\np2 <- post_draws <- brms::as_draws_df(vb_fit) %>% \n  mutate(w_inf = exp((b_a_Intercept/b_b_Intercept)^(1/(1-(2/3))))) %>% \n  filter(w_inf < 700) %>% \n  ggplot(aes(w_inf)) + \n  geom_density() +\n  labs(x = \"\", y = \"Density\") +\n  coord_flip(xlim = c(0, 700)) +\n  scale_y_continuous(breaks = c(0, 0.05)) +\n  theme(panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank()) +\n  NULL\n\np1 + p2 + plot_layout(widths = c(5, 1))\n\n\n\n\n\n\nFurther reading on von Bertalanffy and GOLT\n\nGlobal Change Biology\nLefevre, S., McKenzie, D. J., and Nilsson, G. E. 2017. Models projecting the fate of fish populations under climate change need to be based on valid physiological mechanisms. Global Change Biology, 23: 3449–3459.\nPauly, D., and Cheung, W. W. L. 2018. Sound physiological knowledge and principles in modeling shrinking of fishes under climate change. Global Change Biology, 24: e15–e26.\nLefevre, S., McKenzie, D. J., and Nilsson, G. E. 2018. In modelling effects of global warming, invalid assumptions lead to unrealistic projections. Global Change Biology, 24: 553–556.\nPauly, D., and Cheung, W. W. L. 2018. On confusing cause and effect in the oxygen limitation of fish. Global Change Biology, 24: e743–e744.\n\n\nTrends in Ecology and Evolution\nMarshall, D. J., and White, C. R. 2019. Have we outgrown the existing models of growth? Trends in Ecology & Evolution, 34: 102–111.\nPauly, D. 2019. Female Fish Grow Bigger – Let’s Deal with It. Trends in Ecology & Evolution, 34, 3\nMarshall, D. J., and White, C. R. 2019. Aquatic life history trajectories are shaped by selection, not oxygen limitation. Trends in Ecology & Evolution, 34: 182–184."
  },
  {
    "objectID": "posts/vbge_ode/index.html#references",
    "href": "posts/vbge_ode/index.html#references",
    "title": "Fitting a Pütter/von Bertalanffy ODE in brms",
    "section": "References",
    "text": "References\n\n\nFurther reading on von Bertalnffy and GOLT\n\nGlobal Change Biology\nLefevre, S., McKenzie, D. J., and Nilsson, G. E. 2017. Models projecting the fate of fish populations under climate change need to be based on valid physiological mechanisms. Global Change Biology, 23: 3449–3459.\nPauly, D., and Cheung, W. W. L. 2018. Sound physiological knowledge and principles in modeling shrinking of fishes under climate change. Global Change Biology, 24: e15–e26.\nLefevre, S., McKenzie, D. J., and Nilsson, G. E. 2018. In modelling effects of global warming, invalid assumptions lead to unrealistic projections. Global Change Biology, 24: 553–556.\nPauly, D., and Cheung, W. W. L. 2018. On confusing cause and effect in the oxygen limitation of fish. Global Change Biology, 24: e743–e744.\n\n\nTrends in Ecology and Evolution\nMarshall, D. J., and White, C. R. 2019. Have we outgrown the existing models of growth? Trends in Ecology & Evolution, 34: 102–111.\nPauly, D. 2019. Female Fish Grow Bigger – Let’s Deal with It. Trends in Ecology & Evolution, 34, 3\nMarshall, D. J., and White, C. R. 2019. Aquatic life history trajectories are shaped by selection, not oxygen limitation. Trends in Ecology & Evolution, 34: 182–184."
  }
]